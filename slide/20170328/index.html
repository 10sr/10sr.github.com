<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        // font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }


      .remark-slide-content {
        font-size: 1.7em;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# EditorConfig の全機能を Emacs Lisp で再実装して公式に入れてもらった話

## 2017/3/28

## 10sr

---

# About Me

* 10sr
* XXXXXX
    * Java とか Scala (Apache Spark) とか Python とか
* 好きなものはスクリーンエディタです
    * Emacs 使います
    * micro editor はかわいいです
    * 宗教戦争ダメ絶対
* Docker 始めました
* ドール始めました

---

# EditorConfig


---

# EditorConfig

便利なので使ってみるといいです

* インデント幅などについて、プロジェクトローカルなエディタ設定を行うためのファイル・プラグイン
* エディタ（など）ごとに Plugin がある
    * Emacs, Vim, ATOM, IntelliJ, GitHub...
* それなりに使っている人はいます
    * Nodejs とか Ruby とか Zsh とかのレポジトリにも入ってる


---

# EditorConfig

ファイル例

こういう感じのファイルをレポジトリに置く

```ini
# .editorconfig

[*]
end_of_line = lf
insert_final_newline = true

# 4 space indentation
[*.py]
indent_style = space
indent_size = 4
```

---

# EditorConfig

1. あらかじめエディタに EditorConfig プラグインをインストールしておく
2. ディレクトリに `.editorconfig` ファイルがあると、
3. その設定を自動的に拾ってエディタの設定を変えてくれる！


---

# EditorConfig

**何がうれしいのか？**

* 自分は普段 JavaScript をスペース2個でインデントしてるけど、このレポジトリはタブインデントだ…
    * そのレポジトリに `.editorconfig` があれば、その設定を自動的に使ってくれる
    * わざわざそのレポジトリをさわるためにエディタ全体の設定を変えなくていい
* インデントなどの設定を *定義* できる
    * 自然言語で規約を書かなくても、 `.editorconfig` があれば明示できる

---

# EditorConfig の全機能を Emacs Lisp で再実装する

---

# EditorConfig の全機能を Emacs Lisp で再実装する

なんでそんなことしたの？？？

-> EditorConfig プラグインのインストールが面倒だったから



---

# editorconfig-emacs のインストール

1. 現在の Emacs にはパッケージシステムがある
2. `editorconfig` パッケージもそこからインストールできる
3. *それとは別に* 、 `editorconfig` コマンドをインストールする
    * Emacs とは関係なく、システムのパッケージマネージャなどでインストールする
    * `brew install editorconfig` とか
    * `apt-get install editorconfig` とか


---

# editorconfig-emacs のインストール

* 地味にめんどい…
* Emacs 上でのインストールと、システムのパッケージマネージャでのインストールの二段階をふむ必要がある
* Emacs のパッケージシステムだけでインストールを完結させたい
    * Emacs のセットアップに Emacs 外のシステムをあまり頼りたくない
    * 初期化ファイルの共有だけで Emacs の設定を完結させたい

---

# editorconfig-emacs のインストール

-> editorconfig コマンド部分を Emacs からインストールできるようにしたい

Emacs のパッケージシステムはあまり強くないので、 Emacs Lisp で書かれたもの以外をインストールするのはつらい

---

# editorconfig コマンドは何をしているんだろう？

* 入力：
    * 対象とするファイルの絶対パス
* 出力：
    * `.editorconfig` で定義されたそのファイルのプロパティ値（キーと値のペア）


実行例：

```
$ editorconfig /Users/yuk/.dotfiles/emacs.el
indent_style=space
end_of_line=lf
trim_trailing_whitespace=true
insert_final_newline=true
max_line_length=80
```


---

# editorconfig コマンドは何をしているんだろう？

1. ファイルが与えられると、
2. そのファイルがあるディレクトリに `.editorconfig` を探して
3. INI ファイルをパースして
4. ファイル名の Glob マッチを行って
5. 値を取り出す


---

# editorconfig コマンドは何をしているんだろう？

1. ファイルが与えられると、
2. そのファイルがあるディレクトリに `.editorconfig` を探して
3. INI ファイルをパースして
4. ファイル名の Glob マッチを行って
5. 値を取り出す

＞全部 Emacs Lisp でできそう！！！＜

Emacs Lisp で提供できれば、 Emacs のパッケージシステムでインストールできる


---

# editorconfig-core-emacslisp

やりました。

* 1,000 行程度の Emacs Lisp コード
* Emacs 外への依存なし
* 一週間くらいかかった
* 提供されている単体テストが全部通るのを確認

---

# editorconfig-core-emacslisp

一番辛かったのは fnmatch 部分

* Glob マッチを行うやつ
* EditorConfig の動作に必要な実装が Emacs 上になかった
    * `file5.js` が `file{1..10}.js` にマッチしたりする

仕方ないので全部書き下した

* Python のコードを参考に、 glob 文字列を正規表現に変換した
* 闇っぽい
    * 専用の単体テストを書いた


---

# 書いたし公式に入れてもらおう

…というつもりは始めはあんまりなかった

* でかいし…

---

# 書いたし公式に入れてもらおう

…というつもりは始めはあんまりなかった

* でかいし…

代わりに、それを使うためのインターフェイスを入れようとした





---

以下古い

---

# 既存のコード行数に対して、3倍の行の追加を伴う PR を出しました

---

# 既存のコード行数に対して、3倍の行の追加を伴う PR を出しました

* これ

![addcore](addcore.png)

---

# 既存のコード行数に対して、3倍の行の追加を伴う PR を出しました

それまでのソースの行数

* 350 行

この PR による追加

* `+1,152 -17`

---

# 既存のコード行数に対して、3倍の行の追加を伴う PR を出しました

どういう経緯でそういう PR を出したのか、どうやってそれがマージされたのかについて喋ります。

---

# 出したレポジトリ

* editorconfig-emacs
  * EditorConfig プロジェクトの Emacs プラグイン

---

# 出したレポジトリ

* editorconfig-emacs
  * EditorConfig プロジェクトの Emacs プラグイン

## EditorConfig?
* プロジェクトローカルなエディタ設定を共通化するファイル
  * 申し訳ないですが詳しい説明はおこないません＞＜
    * ググれば解説記事はたくさん出ると思います。便利なので使ってみるといいです
* エディタ（など）ごとに Plugin がある
  * Emacs, Vim, ATOM, IntelliJ, GitHub...


---

# 問題だったこと

Emacs にはプラグイン管理システムがありますが、 EditorConfig プラグインのインストールはちょっと面倒だった

1. Emacs パッケージシステムで EditorConfig プラグイン（ Emacs Lisp 部分）を導入する
2. *それとは別に* 、システムのパッケージマネージャなどで `editorconfig` コマンドを導入する
  * `brew install editorconfig` など

---

# 問題だったこと

Emacs にはプラグイン管理システムがありますが、 EditorConfig プラグインのインストールはちょっと面倒だった

1. Emacs パッケージシステムで EditorConfig プラグイン（ Emacs Lisp 部分）を導入する
2. *それとは別に* 、システムのパッケージマネージャなどで `editorconfig` コマンドを導入する
  * `brew install editorconfig` など

ほんとは Emacs にプラグイン導入するだけで使えるようになってほしい…

* エディタの設定なのに、そこだけ外部の環境に依存する
* 初期化ファイルの共有だけで Emacs の設定が完結しない
* <font color="red">＞地味に不便＜</font>

---

# 不便なのでどうにかしたい

具体的には、 `editorconfig` コマンドのインストールをなしで済ませたい

---

# 不便なのでどうにかしたい

具体的には、 `editorconfig` コマンドのインストールをなしで済ませたい

-> `editorconfig` コマンドの全機能を Emacs Lisp で実装してしまえばいいのでは？？？？？

---

# 不便なのでどうにかしたい

具体的には、 `editorconfig` コマンドのインストールをなしで済ませたい

-> `editorconfig` コマンドの全機能を Emacs Lisp で実装してしまえばいいのでは？？？？？

-> しました

* 一週間くらいでガリガリ書いた
* fnmatch (Glob) を再実装する必要があったりしたのがアレだった

---

## テスト通ったしプラグインから使ってもらうようにしたいな

この時点で本家に取り込んでもらう気満々だった

---

## テスト通ったしプラグインから使ってもらうようにしたいな

この時点で本家に取り込んでもらう気満々だった

自分の実装は 1000 行超、それに対し今あるコードは 350 行程度

-> いや無理でしょ…

* 勝手にやってる野良プロジェクト
* 自分は EditorConfig とはなんの関係もなかった

---

じゃあどうしようか？

もともとの目的は、 Emacs パッケージだけで完結することだったはず

プラグインに取り込んでもらう必要はない

公開して、使えるようになれば十分では

`editorconfig` コマンドとどちらを使うようにするか選択できるようにしよう

-> 使用する関数を設定できる変数を追加する PR を出した

-> これ全部こっちにいれちゃおうぜ。あと Emacs あんまり分かる人いないから Organization 入ってよ

-> はい








    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
